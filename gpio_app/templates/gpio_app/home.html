{% extends "base_website.html" %}

{% block content %}
<div>
    <div>
        <h1>{{ info.label }}</h1><i> {{ info.desc }} </i>
    </div>
    <br>
    <br>
    <h2>OUTPUT PINS</h2>
    <table style="width:100%">
        <col width="5%">
        <col width="10%">
        <col width="5%">
        <col width="5%">
        <col width="10%">
        <col width="10%">
        <col width="10%">
        <col width="10%">
        <col>
        {% for gpio in gpio_list %}
            {% if gpio.iou == 'out' %}
                <tr>
                    <td>{{ gpio.pin }}</td>
                    <td>{{ gpio.label }}</td>
                    <td>{{ gpio.iou }}</td>
                    <td class="lowhigh">{{ gpio.lowhigh }}</td>
                    <td><button id="btn_{{ gpio.pin }}_unset">unset</button></td>
                    <td><button id="btn_{{ gpio.pin }}_refresh">refresh</button></td>
                    <td><button id="btn_{{ gpio.pin }}_setlow">set low</button></td>
                    <td><button id="btn_{{ gpio.pin }}_sethigh">set high</button></td>
                    <td class="msg">...</td>
                </tr>
            {% endif %}
        {% endfor %}
    </table>
    <br>
    <br>
    <h2>INPUT PINS</h2>
    <table style="width:100%">
        <col width="5%">
        <col width="10%">
        <col width="5%">
        <col width="5%">
        <col width="10%">
        <col width="10%">
        <col>
        {% for gpio in gpio_list %}
            {% if gpio.iou == 'in' %}
                <tr>
                    <td>{{ gpio.pin }}</td>
                    <td>{{ gpio.label }}</td>
                    <td>{{ gpio.iou }}</td>
                    <td class="lowhigh">{{ gpio.lowhigh }}</td>
                    <td><button id="btn_{{ gpio.pin }}_unset">unset</button></td>
                    <td><button id="btn_{{ gpio.pin }}_refresh">refresh</button></td>
                    <td class="msg">...</td>
                </tr>
            {% endif %}
        {% endfor %}
    </table>
    <br>
    <br>
    <h2>UNSET PINS</h2>
    <table style="width:100%">
        <col width="5%">
        <col width="10%">
        <col width="5%">
        <col width="10%">
        <col width="10%">
        <col>
        {% for gpio in gpio_list %}
            {% if gpio.iou == 'unset' %}
                <tr>
                    <td>{{ gpio.pin }}</td>
                    <td>{{ gpio.label }}</td>
                    <td>{{ gpio.iou }}</td>
                    <td><button id="btn_{{ gpio.pin }}_setasinput">set as input</button></td>
                    <td><button id="btn_{{ gpio.pin }}_setasoutput">set as output</button></td>
                    <td class="msg">...</td>
                </tr>
            {% endif %}
        {% endfor %}
    </table>
    <br>
    <br>
    <div id="p_log">
    </div>
</div>

{% endblock %}

{% block scripts %}
{%comment%}scripts put in the side bar block, but this is just a workaround to get the scripts working{%endcomment%}

<script>

function make_click_func(url, data){
    function func(){
        var btn =  $(this)
        btn.prop('disabled', true);

        $.ajax({
            url: url,
            data: data,
            success: function (data, textStatus, jqXHR) {
                if ('error' in data) {
                    btn.parent().parent().find('.msg').html("server error: " + d["error"]);
                    alert("server error for " + url + data['error'])
                }
                var d = data
                btn.prop('disabled', false);
                btn.parent().parent().find('.msg').html(d["msg"]);
                btn.parent().parent().find('.lowhigh').html(d["lowhigh"]);

                var log = document.createElement('p');
                log.innerHTML = d["msg"];
                $("#p_log")[0].appendChild( log )

            },
            error: function (err) {
                e = err
                btn.parent().parent().find('.msg').html("ajax error");
                alert("ajax error for " + url + " error = " + err)
                btn.prop('disabled', false);
            }

        });
    }
    return func
}


{% for gpio in gpio_list %}
    {% if gpio.iou == 'in' %}
        {% with "refresh unset" as list_cmd %}
            {% for cmd in list_cmd.split %}
                $("#btn_{{ gpio.pin }}_{{ cmd }}").click(make_click_func("{% url "gpio_app.views.control" %}", {"pin":{{ gpio.pin }}, "iou":"in", "cmd":"{{ cmd }}"}))
            {% endfor %}
        {% endwith %}
    {% endif %}
    {% if gpio.iou == 'out' %}
        {% with "unset refresh setlow sethigh" as list_cmd %}
            {% for cmd in list_cmd.split %}
                $("#btn_{{ gpio.pin }}_{{ cmd }}").click(make_click_func("{% url "gpio_app.views.control" %}", {"pin":{{ gpio.pin }}, "iou":"out", "cmd":"{{ cmd }}"}))
            {% endfor %}
        {% endwith %}
    {% endif %}
    {% if gpio.iou == 'unset' %}
        {% with "setasinput setasoutput" as list_cmd %}
            {% for cmd in list_cmd.split %}
                $("#btn_{{ gpio.pin }}_{{ cmd }}").click(make_click_func("{% url "gpio_app.views.control" %}", {"pin":{{ gpio.pin }}, "iou":"unset", "cmd":"{{ cmd }}"}))
            {% endfor %}
        {% endwith %}
    {% endif %}
{% endfor %}

</script>
{% endblock %}



