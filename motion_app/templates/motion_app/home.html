{% extends "base.html" %}

{% block content %}

<div>
    <div>
        <h1>MOTION_APP</h1>
        <i>record motion videos and stream videos</i>
    </div>
    <br>
    <br>
    <div style="width: 40%; float:left; ">
        <h2>Commands</h2>

        <table style="width:100%">
            <col width="25%">
            <col width="75%">
            {% for d in lis_signals %}
                <tr>
                    <td><button type="button" id="btn_{{ d.name }}" style="width: 100%">send {{ d.btn }}</button></td>
                    <td>{{ d.desc }}</td>
                </tr>
            {% endfor %}
            {% with "get_files recent_events start_stream" as lis %}
                {% for s in lis.split %}
                <tr>
                    <td><button type="button" id="btn_{{ s }}" style="width: 100%">{{ s }}</button></td>
                    <td>some explanations</td>
                </tr>
                {% endfor %}
            {% endwith %}
        </table>
        <br>
        <br>
        {% autoescape off %}
        <div>

            <h2>Documentation</h2>
            <p>This app runs another software called <a href="http://www.lavrsen.dk/foswiki/bin/view/Motion/WebHome">motion</a></p>

            <h3>Definitions</h3>
            <ul>
                <li><h4>Motion</h4>
                    <p>The app processes the images of the camera, when there is a change in the images of more than {{motion_conf.threshold}} pixels, for {{motion_conf.minimum_motion_frames}} frames in a row, then a motion is detected.</p>
                </li>
                <li><h4>Event</h4>
                <p>An event is a series of motions that occure within a small timeframe. The event ends when there is no motion for {{motion_conf.gap}} seconds</p>
                </li>
            </ul>
            <h3>Services</h3>
            <ul>

                <li><h4>motion-triggered video files</h4>
                    <p>The app records the motions from {{motion_conf.pre_capture}} frames before the motion, till {{motion_conf.post_capture}} frames after the motion.
                    </p>
                    <p>
                       Motions that are close to each other (i.e. within the same event) are saved in one file
                    </p>
                    <p>
                       The {{motion_conf.ffmpeg_video_codec}} codec is used to save the file
                       Files are saved in the with name {{motion_conf.movie_filename}} in the {{motion_conf.target_dir}} directoy
                    </p></li>

                <li><h4>motion-triggered images</h4>
                <p>If {{motion_conf.output_normal}} is on, the images where motion is detected are saved.
                    If it's off, they are not saved, If it's first, then the first image of an event is saved,
                    If it's best, then the picture of the most motion in an event is saved.
                    If it's center, then the image with the motion close to the center is saved
                </p>
                <p>If {{motion_conf.output_motion}} is on, then only the pixels with the moving objects are saved (ghost images)
                </p></li>

                <li><h4>livestream</h4>
                   Live stream of the camera is also provided on port {{motion_conf.webcam_port}}, access to this could be restricted to localhost if {{motion_conf.webcam_localhost}} is on.
                   If {{motion_conf.webcam_motion }} is on, then the output stream will be at 1 fps when there is no motion and when there is motion, it goes back up to {{motion_conf.webcam_maxrate }}
                </li>

                <li><h4>control configuration</h4>
                   <p>on port {{motion_conf.control_port}} the configuration of the motion software can be accessed, this is also restricted to localhost if {{motion_conf.control_localhost}} is on
                   </p></li>

                <li><h4>timelapse</h4>
                <p>if {{motion_conf.ffmpeg_timelapse}}is not 0, timelapse will be on and the period between the shots is {{motion_conf.ffmpeg_timelapse}} seconds</p></li>

                <li><h4>snapshots</h4>
                <p>if {{motion_conf.snapshot_interval}}is not 0, snapshots will be on and the period between the shots is {{motion_conf.snapshot_interval}} seconds.
                The file ill be named {{motion_conf.snapshot_filename }}
                </p></li>

            </ul>
        </div>
        {% endautoescape %}
    </div>
    <div>
        <img id="img_stream">
    </div>
    <div style="width: 60%; float:left; ">
        <h2> >>  </h2>
        <p id="p_jsresponse">...</p>
        <h2> <<  </h2>
    </div>

</div>

{% endblock %}

{% block sidebar %}{% comment %}scripts put in the side bar block, but this is just a workaround to get the scripts working{% endcomment %}

<script>
function syntaxHighlight(json) {
    if (typeof json != 'string') {
         json = JSON.stringify(json, undefined, 2);
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'key';
            } else {
                cls = 'string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'boolean';
        } else if (/null/.test(match)) {
            cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}

function make_click_function(url, sdata){
    function func(){
        var btn =  $(this)
        btn.prop('disabled', true);

        $.ajax({
            url: url,
            data: sdata,
            success: function (data, textStatus, jqXHR) {
                if ('error' in data) {
                    alert("server error for " + url + data['error'])
                }
                d = data
                var p_update = $('#p_jsresponse')
                var s = JSON.stringify(data, undefined, 4).replace(/(?: )/g, '&nbsp;').replace(/(?:\r\n|\r|\n)/g, '<br />');
                p_update.html("<pre><code>" + s + "</code></pre>")
                btn.prop('disabled', false);


            },
            error: function (err) {
                e = err
                alert("ajax error for " + url + " error = " + err)
                btn.prop('disabled', false);
            }

        });
    }
    return func
}

// assigning click functions to buttons

{% for d in lis_signals %}
    $("#btn_{{ d.name }}").click(make_click_function("/motion_app/send_signal", { "cmd": "{{d.name}}" }))
{% endfor %}

$("#btn_recent_events").click(make_click_function("/motion_app/recent_events", {"name":"all"}))
$("#btn_get_files").click(make_click_function("/motion_app/get_files"))

$("#btn_start_stream").click(function (){
    var img = $('#img_stream');
    img[0].setAttribute('src','http://192.168.1.201:9002');
    var btn = $("#btn_start_stream")
    btn.remove()
        }
)

</script>
<style>
code {
    color: blue
}
</style>
{% endblock %}



